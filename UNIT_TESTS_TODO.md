# AGraph 单元测试 TODO 清单

> 基于当前 27% 测试覆盖率分析，优先补充关键功能模块的单元测试
> **最新更新**: API 模块测试已全部完成 (11/11 文件) ✅

## 🚨 最高优先级 (覆盖率 < 30%)

### 1. API 模块测试 (已完成: 11/11 文件 ✅)

#### 1.1 核心 API 应用 - `tests/test_api_app.py` ✅
- [x] FastAPI 应用初始化测试
- [x] 中间件功能测试 (CORS, 日志记录)
- [x] 健康检查端点测试
- [x] 异常处理器测试
- [x] 应用生命周期管理测试

#### 1.2 API 路由测试 ✅
- [x] `tests/test_api_knowledge_graph.py` - 知识图谱路由 ✅
  - [x] 创建/删除图谱
  - [x] 实体 CRUD 操作
  - [x] 关系 CRUD 操作
  - [x] 图谱统计查询
  - [x] 文本提取工具测试
- [x] `tests/test_api_documents.py` - 文档管理路由 ✅
  - [x] 文档上传/删除
  - [x] 批量文档处理
  - [x] 文档状态查询
  - [x] 项目特定操作
- [x] `tests/test_api_projects.py` - 项目管理路由 ✅
  - [x] 项目 CRUD 操作
  - [x] 项目配置管理
  - [x] 项目统计查询
- [x] `tests/test_api_config.py` - 配置管理路由 ✅
  - [x] 配置读取/更新
  - [x] 环境变量处理
  - [x] 文件保存/加载
- [x] `tests/test_api_cache.py` - 缓存管理路由 ✅
  - [x] 缓存统计查询
  - [x] 缓存清理操作
  - [x] 分页和过滤
- [x] `tests/test_api_chat.py` - 聊天功能路由 ✅
  - [x] 对话创建/管理
  - [x] 消息处理
  - [x] 流式/非流式聊天
- [x] `tests/test_api_search.py` - 搜索功能路由 ✅
  - [x] 实体搜索
  - [x] 关系搜索
  - [x] 文本块搜索
- [x] `tests/test_api_system.py` - 系统管理路由 ✅
  - [x] 系统状态查询
  - [x] 性能指标
  - [x] 缓存管理

#### 1.3 API 依赖注入 - `tests/test_api_dependencies.py` ✅
- [x] AGraph 实例管理
- [x] 依赖注入容器测试
- [x] 资源生命周期管理
- [x] 项目隔离测试
- [x] 配置变更处理

### 2. 核心基础设施测试 (已完成: 4/4 文件 ✅ 覆盖率: 20% → 36%+)

#### 2.1 索引管理器 - `tests/test_index_manager.py` ✅ (覆盖率: 52%)
- [x] 索引创建和删除
- [x] 实体类型索引操作
- [x] 关系-实体索引操作
- [x] 实体-关系索引操作
- [x] 实体-集群索引操作
- [x] 实体-文本块索引操作
- [x] 批量索引重建
- [x] 索引统计和性能监控
- [x] 线程安全测试
- [x] 批量实体移除操作
- [x] 索引一致性验证
- [x] 大数据集性能测试
- [x] 边界条件和错误处理

#### 2.2 缓存管理器 - `tests/test_cache_manager.py` ✅ (覆盖率: 50%)
- [x] LRU 缓存策略测试
- [x] TTL 缓存策略测试
- [x] LRU+TTL 组合策略测试
- [x] 缓存失效机制测试
- [x] 标签式缓存失效测试
- [x] 缓存统计和监控测试
- [x] 并发缓存访问测试
- [x] 缓存装饰器功能测试
- [x] 缓存条目生命周期管理
- [x] 自定义键函数支持
- [x] 内存使用模式测试
- [x] 缓存策略行为验证

#### 2.3 优化知识图谱 - `tests/test_optimized_knowledge_graph.py` ✅ (覆盖率: 24%)
- [x] 图谱初始化和配置
- [x] 实体管理操作 (增删改查)
- [x] 关系管理操作 (增删改查)
- [x] 集群管理操作
- [x] 文本块管理操作
- [x] 图谱统计计算
- [x] 连通组件分析
- [x] 性能优化功能
- [x] 缓存集成测试
- [x] 索引集成测试
- [x] 数据序列化/反序列化
- [x] 图谱合并功能
- [x] 完整性验证
- [x] 层次集群管理
- [x] 大规模图谱性能测试
- [x] 完整工作流集成测试

#### 2.4 核心基础设施简化测试 - `tests/test_core_infrastructure.py` ✅
- [x] 基本 CRUD 操作验证
- [x] 索引-缓存集成测试
- [x] 性能指标收集测试

**🎯 关键成果**:
- **IndexManager**: 20% → 52% 覆盖率 (+160%)
- **CacheManager**: 20% → 50% 覆盖率 (+150%)
- **OptimizedKnowledgeGraph**: 20% → 24% 覆盖率 (+20%)
- **总体基础设施覆盖率**: 20% → 36% 覆盖率 (+80%)
- **修复 Bug**: IndexManager 批量移除方法中的实体类型索引问题
- **测试用例总数**: 70+ 个测试用例，涵盖所有核心功能

### 3. 事务系统测试 (当前: 88% 覆盖率) ✅ **已完成**

#### 3.1 ACID 事务管理 - `tests/test_transaction_manager.py` ✅
- [x] 事务生命周期管理
- [x] 多种隔离级别测试
- [x] 并发事务处理
- [x] 死锁检测和解决
- [x] 锁管理功能
- [x] 事务超时处理
- [x] 保存点功能
- [x] 事务统计和监控
- **覆盖率**: 92% (394行代码，33行未覆盖)
- **测试用例**: 63个，全部通过

#### 3.2 批处理操作 - `tests/test_batch_operations.py` ✅
- [x] 批处理上下文管理
- [x] 原子性批处理操作
- [x] 批处理回滚机制
- [x] 事务感知批处理
- [x] 批处理性能监控
- [x] 错误处理和恢复
- **覆盖率**: 79% (356行代码，75行未覆盖)
- **测试用例**: 54个，全部通过

#### 3.3 数据访问层 - `tests/test_dao.py` ✅
- [x] DAO 基本 CRUD 操作
- [x] 事务上下文管理
- [x] 数据持久化
- [x] 查询接口测试
- **覆盖率**: 92% (391行代码，32行未覆盖)
- **测试用例**: 45个，全部通过

**总计**: 162个测试用例全部通过，覆盖率从 < 25% 提升至 88%

## 🔶 中等优先级 (覆盖率 30-60%)

### 4. 文档处理器测试 (已完成: 8/8 文件 ✅ 覆盖率: 15% → 70%+)

#### 4.1 处理器工厂 - `tests/test_processor/test_processor_factory.py` ✅
- [x] 处理器注册和获取 (24个测试用例)
- [x] 文件类型检测
- [x] 处理器选择逻辑
- [x] 批量处理功能
- [x] 缓存和性能优化
- [x] 全局便利函数

#### 4.2 各类型处理器测试 ✅
- [x] `tests/test_processor/test_pdf_processor.py` - PDF 文档处理 (17个测试用例) ✅
- [x] `tests/test_processor/test_word_processor.py` - Word 文档处理 (24个测试用例) 🔧
- [x] `tests/test_processor/test_html_processor.py` - HTML 处理 (26个测试用例) 🔧
- [x] `tests/test_processor/test_json_processor.py` - JSON 处理 (29个测试用例) ✅
- [x] `tests/test_processor/test_spreadsheet_processor.py` - 电子表格处理 (29个测试用例) 🔧
- [x] `tests/test_processor/test_image_processor.py` - 图像处理 (29个测试用例) 🔧
- [x] `tests/test_processor/test_text_processor.py` - 文本处理 (21个测试用例) ✅

**🎯 关键成果**:
- **文档处理器测试**: 199个测试用例已创建
- **工厂模式**: 24个测试用例全部通过
- **PDF处理**: 17个测试用例全部通过
- **JSON处理**: 29个测试用例中25个通过
- **文本处理**: 21个测试用例中19个通过
- **注**: 部分测试需要修复外部依赖的mock补丁 (BeautifulSoup, docx, pandas等)

### 5. 构建器组件测试

#### 5.1 知识图谱构建器 - `tests/test_graph_builder.py`
- [ ] 构建器初始化
- [ ] 端到端构建流程
- [ ] 增量构建功能
- [ ] 配置管理
- [ ] 缓存集成

#### 5.2 提取器测试 - `tests/test_extractors.py`
- [ ] LLM 实体提取
- [ ] LLM 关系提取
- [ ] 提取器配置管理
- [ ] 提取结果验证

#### 5.3 聚类算法测试 - `tests/test_clustering.py`
- [ ] 社区检测算法
- [ ] 层次聚类算法
- [ ] 聚类结果评估

### 6. 向量数据库测试

#### 6.1 ChromaDB 集成 - `tests/test_chroma_vectordb.py` (需增强)
- [ ] 集合管理操作
- [ ] 向量存储和检索
- [ ] 文本块操作 (修复现有错误)
- [ ] 相似性搜索
- [ ] 元数据过滤

#### 6.2 嵌入管理 - `tests/test_embeddings.py` (需增强)
- [ ] 多种嵌入模型支持
- [ ] 嵌入缓存机制
- [ ] 嵌入质量评估

## 🔷 较低优先级 (覆盖率 > 60%)

### 7. 工具和辅助功能

#### 7.1 配置管理 - `tests/test_config.py` (需增强)
- [ ] 环境变量处理
- [ ] 配置验证
- [ ] 配置热更新

#### 7.2 日志系统 - `tests/test_logger.py`
- [ ] 日志级别配置
- [ ] 日志格式化
- [ ] 性能日志记录

#### 7.3 工具函数 - `tests/test_utils.py`
- [ ] 通用工具函数
- [ ] 数据验证函数

## 📋 测试实现指南

### 测试文件结构
```
tests/
├── unit/                    # 单元测试
│   ├── api/                # API 测试
│   ├── base/               # 核心组件测试
│   ├── builder/            # 构建器测试
│   ├── processor/          # 处理器测试
│   └── vectordb/           # 向量数据库测试
├── integration/            # 集成测试
└── performance/            # 性能测试
```

### 测试覆盖率目标
- **整体目标**: 从 27% 提升到 80%+ (当前进度: ~40%+)
- **API 模块**: 0% → ✅ 已完成 (11 个测试文件，208+ 测试用例)
- **核心基础设施**: 20% → ✅ 已完成 36%+ (4 个测试文件，70+ 测试用例)
- **事务系统**: 25% → ✅ 88% 已完成 (3个测试文件，162个测试用例)
- **处理器**: 15% → 70%+ (待实现)
- **向量数据库**: 30% → 70%+ (待实现)
- **构建器组件**: 15% → 60%+ (待实现)

### 重点测试场景

#### API 测试重点
- HTTP 状态码验证
- 请求/响应模型验证
- 错误处理和异常情况
- 认证和授权 (如果有)
- 并发请求处理

#### 核心组件测试重点
- 数据完整性验证
- 性能优化功能
- 并发安全性
- 内存管理
- 错误边界情况

#### 事务系统测试重点
- ACID 属性验证
- 并发事务处理
- 死锁检测和解决
- 隔离级别实现
- 回滚机制完整性

### 测试工具和框架
- **测试框架**: unittest (项目现有)
- **模拟**: unittest.mock
- **异步测试**: asyncio + unittest
- **性能测试**: pytest-benchmark (可选)
- **覆盖率**: coverage

### 立即行动项
1. 修复现有测试中的 2 个失败用例
2. 修复 ChromaDB 嵌入函数配置问题
3. 从 API 模块开始，优先实现高价值测试
4. 建立 CI/CD 测试流水线确保测试质量

---

**注意**: 优先实现标记为 🚨 的最高优先级测试，这些模块是系统的核心功能，测试覆盖对系统稳定性至关重要。
